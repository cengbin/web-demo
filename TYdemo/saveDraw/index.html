<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" id="viewport" content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>saveDraw</title>
    <link type="text/css" rel="stylesheet" href="style.css" />

</head>
<body>
    <script src="libs/zepto.min.js"></script>

    <div id="page1">
        <div style="width:288px" class="page1div">
            <div id="logo">
                <img style="width:253px;height :250px;" src="logo.png" ></img>
            </div>

            <div class="js-retina" id="nextBtn" href="">
                <div class="js-retina-text">Play</div>
            </div>
        </div>
    </div>

    <script>

    var username = '';
        
    var bgImage = new Image();
    bgImage.src = "bg.png";
    bgImage.onload = function ()
    {
        $('#nextBtn').click(function ()
        {
            if (username == '' || username == " " || username == "null" || username == null)
            {
                username = window.prompt("请输入开票人姓名", "");

                if (!(username == '' || username == " " || username == "null" || username == null))
                {
                    drawImage(bgImage);
                }
            }
            else
            {
                drawImage(bgImage);
            }
        });
    }
    

    function drawImage(_image)
    {
        $('#page1').hide();


        var _w=_image.width;
        var _h=_image.height;

        var imgCanvas = document.createElement('canvas');
        imgCanvas.style.display = "block";
        imgCanvas.id="imgCanvas";
        document.body.appendChild(imgCanvas);
        imgCanvas.width=_w;
        imgCanvas.height=_h;
        var imgContext=imgCanvas.getContext("2d");

        imgContext.drawImage(_image,0,0,_w,_h,0,0,_w,_h);

        imgContext.font      = "normal 14px KaiTi";
        imgContext.fillStyle = "#666666";
        imgContext.fillText(username, 270, 288);
        imgContext.restore();


        var image = imgCanvas.toDataURL("image/png");
        var imageData = image.substr(22); //去掉 data:image/png;base64,

        //var w=window.open('about:blank','image from canvas');
        //w.document.write("<img src='"+image+"' alt='from canvas'/>");


// return;
        document.body.removeChild(imgCanvas);

        PostImage(imageData,end)
    }

    function PostImage(_sourceData,_success)
    {
        $.post("upload.php",{sourceData:_sourceData},
            _success
        );
    }


    function end(data)
    {
        window.location.replace(data);
    }



    </script>


</body>
</html>